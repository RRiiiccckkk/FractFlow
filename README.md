# FractFlow

FractFlow is a fractal intelligence architecture that decomposes intelligence into nestable Agent-Tool units, building dynamically evolving distributed cognitive systems through recursive composition.

## Design Philosophy

FractFlow is a fractal intelligence architecture that decomposes intelligence into nestable Agent-Tool units, building dynamically evolving distributed cognitive systems through recursive composition.

Each agent not only possesses cognitive capabilities but also has the ability to call other agents, forming self-referential, self-organizing, and self-adaptive intelligent flows.

Similar to how each tentacle of an octopus has its own brain in a collaborative structure, FractFlow achieves structurally malleable and behaviorally evolving distributed intelligence through the combination and coordination of modular intelligence.

## Installation

Please install "uv" first: https://docs.astral.sh/uv/#installation

```bash
uv venv
source .venv/bin/activate
uv pip install -r requirements.txt
```

Note: The project is still under development. If dependencies are not satisfied, please install manually: `uv pip install XXXX`.

### Advantages of uv Environment Isolation

When the tool ecosystem expands, different tools may require different dependency package versions. uv provides powerful environment isolation capabilities:

```bash
# Create independent environment for specific tools
cd tools/your_specific_tool/
uv venv
source .venv/bin/activate

# Install tool-specific dependencies
uv pip install specific_package==1.2.3

# Tool will use independent environment when running
python your_tool_agent.py
```

**Particularly useful scenarios**:
- **Third-party tool integration**: Avoid dependency conflicts when wrapping tools from other GitHub repositories
- **Version compatibility**: Different tools need different versions of the same library
- **Experimental development**: Test new dependencies without affecting the main environment

This flexible environment management allows FractFlow to support more complex and diverse tool ecosystems.

## Environment Configuration

### .env File Setup

Create a `.env` file in the project root directory to configure necessary API keys:

```bash
# Create .env file
touch .env
```

Example `.env` file content:

```env
# AI Model API Keys (configure at least one)

# DeepSeek API Key
DEEPSEEK_API_KEY=your_deepseek_api_key_here

# OpenAI API Key (for GPT models and image generation)
OPENAI_API_KEY=your_openai_api_key_here
COMPLETION_API_KEY=your_openai_api_key_here

# Qwen API Key (Alibaba Cloud Tongyi Qianwen)
QWEN_API_KEY=your_qwen_api_key_here

# Optional: Custom API Base URLs
# DEEPSEEK_BASE_URL=https://api.deepseek.com
# OPENAI_BASE_URL=https://api.openai.com/v1
```

### API Key Acquisition

#### DeepSeek (Recommended)
1. Visit [DeepSeek Open Platform](https://platform.deepseek.com/)
2. Register an account and obtain API key
3. Set `DEEPSEEK_API_KEY` environment variable

#### OpenAI
1. Visit [OpenAI API Platform](https://platform.openai.com/api-keys)
2. Create API key
3. Set `OPENAI_API_KEY` and `COMPLETION_API_KEY` environment variables
4. **Note**: Image generation functionality requires OpenAI API key

#### Qwen (Optional)
1. Visit [Alibaba Cloud DashScope](https://dashscope.console.aliyun.com/)
2. Enable Tongyi Qianwen service and obtain API key
3. Set `QWEN_API_KEY` environment variable

### Configuration Validation

Verify that environment configuration is correct:

```bash
# Test basic functionality
python tools/core/weather/weather_agent.py --query "How is the weather in New York?"
```

## Quick Start

### üöÄ Frontend Assistant - Recommended Entry Point

The easiest way to experience FractFlow is through our unified frontend interface:

```bash
# Launch interactive mode selection
python ÂâçÁ´Ø/hkust_ai_assistant_entry.py

# Choose from 4 modes:
# 1. üìö Academic Q&A Mode - Academic consulting and research support
# 2. üé§ Default Voice Mode - Qwen Omni voice, quick conversation  
# 3. üéì Principal Ni Voice Mode - Principal Ni's voice cloning, authoritative academic communication
# 4. ‚ö° Manual Real-time Interruption Mode - Millisecond-level interruption, ultimate control experience
```

**Direct mode launch**:
```bash
python ÂâçÁ´Ø/hkust_ai_assistant_entry.py --mode academic         # Academic mode
python ÂâçÁ´Ø/hkust_ai_assistant_entry.py --mode voice           # Default voice mode
python ÂâçÁ´Ø/hkust_ai_assistant_entry.py --mode ni-voice        # Principal Ni voice mode  
python ÂâçÁ´Ø/hkust_ai_assistant_entry.py --mode manual-interrupt # Manual interruption mode
```

### Basic Tool Usage

Each tool in FractFlow supports three running modes:

```bash
# MCP Server mode (default, no need to start manually, usually started automatically by programs)
python tools/core/file_io/file_io_agent.py

# Interactive mode
python tools/core/file_io/file_io_agent.py --interactive

# Single query mode
python tools/core/file_io/file_io_agent.py --query "Read README.md file"
```

### First Tool Run

Let's run a simple file operation:

```bash
python tools/core/file_io/file_io_agent.py --query "Read the first 10 lines of README.md file in project root directory"
```

## Tool Development Tutorial

### 5-Minute Quick Start: Hello World Tool

Creating your first FractFlow tool only requires inheriting `ToolTemplate` and defining two required attributes:

```python
# my_hello_tool.py
import os
import sys

# Add project root directory to Python path
current_dir = os.path.dirname(os.path.abspath(__file__))
project_root = os.path.abspath(os.path.join(current_dir, '../..'))
sys.path.append(project_root)

from FractFlow.tool_template import ToolTemplate

class HelloTool(ToolTemplate):
    """Simple greeting tool"""
    
    SYSTEM_PROMPT = """
You are a friendly greeting assistant.
When users provide names, please give personalized greetings.
Please reply in Chinese, maintaining a friendly and enthusiastic tone.
"""
    
    TOOL_DESCRIPTION = """
Tool for generating personalized greetings.

Parameters:
    query: str - User's name or greeting request

Returns:
    str - Personalized greeting message
"""

if __name__ == "__main__":
    HelloTool.main()
```

Run your tool:

```bash
# Interactive mode
python my_hello_tool.py --interactive

# Single query
python my_hello_tool.py --query "My name is Zhang San"
```

**Core Concept Understanding:**
- `SYSTEM_PROMPT`: Defines agent behavior and response style
- `TOOL_DESCRIPTION`: **Important**: This is the tool usage manual exposed to upper-layer Agents. In fractal intelligence, upper-layer Agents read this description to understand how to call lower-layer tools
- `ToolTemplate`: Provides unified runtime framework (MCP server, interactive, single query - three modes)

### 30-Minute Practice: Three Classic Scenarios

#### Scenario 1: File Operation-Based Tool Development

**Reference Implementation**: [`tools/core/file_io/file_io_agent.py`](tools/core/file_io/file_io_agent.py)

**Extension Points**:
- Inherit `ToolTemplate` base class to get three running mode support
- Reference `file_io_mcp.py` as underlying file operation tool
- Customize `SYSTEM_PROMPT` to implement specific file analysis logic
- Configure appropriate iteration count and model parameters

**Creation Steps**:
1. Copy basic structure of file_io_agent.py
2. Modify `SYSTEM_PROMPT` to add your analysis logic (such as statistical analysis, content summarization, etc.)
3. Adjust `TOOL_DESCRIPTION` to describe new functionality features
4. Adjust parameters in `create_config()` according to task complexity

**Core Configuration Example**:
```python
TOOLS = [("tools/core/file_io/file_io_mcp.py", "file_operations")]
# Add your professional analysis prompts to SYSTEM_PROMPT
```

#### Scenario 2: Image Generation Integration Tool Development

**Reference Implementation**: [`tools/core/gpt_imagen/gpt_imagen_agent.py`](tools/core/gpt_imagen/gpt_imagen_agent.py)

**Core Features**:
- Support both text-to-image and image editing modes
- Strict path parameter preservation strategy
- Automatic prompt optimization mechanism

**Customization Directions**:
- **Prompt Engineering**: Modify `SYSTEM_PROMPT` to add specific prompt optimization strategies
- **Post-processing Integration**: Combine with other image processing tools for composite functionality
- **Batch Processing**: Extend to support multi-image generation workflows
- **Style Customization**: Optimize for specific artistic styles or purposes

**Key Configuration**:
```python
TOOLS = [("tools/core/gpt_imagen/gpt_imagen_mcp.py", "gpt_image_generator_operations")]
# Define your image generation strategy in SYSTEM_PROMPT
```

#### Scenario 3: Fractal Intelligence Demonstration (Visual Article Agent)

**Complete Implementation**: [`tools/composite/visual_article_agent.py`](tools/composite/visual_article_agent.py)

**Extension Directions**:
- Add more professional tools (such as web search, data analysis)
- Implement more complex content generation strategies
- Integrate different file format outputs

**Core Understanding of Fractal Intelligence**:
- **Recursive Composition**: Tools can call other tools, forming multi-layer intelligent structures
- **Professional Division**: Each tool focuses on specific domains, achieving complex functionality through combination
- **Adaptive Coordination**: High-level tools dynamically select and combine low-level tools based on task requirements

### Deep Mastery: Architectural Principles

#### ToolTemplate Lifecycle

```python
# 1. Class Definition Phase
class MyTool(ToolTemplate):
    SYSTEM_PROMPT = "..."      # Define agent behavior
    TOOL_DESCRIPTION = "..."   # Define tool interface
    TOOLS = [...]              # Declare dependent tools

# 2. Initialization Phase
@classmethod
async def create_agent(cls):
    config = cls.create_config()           # Create configuration
    agent = Agent(config=config)           # Create agent
    await cls._add_tools_to_agent(agent)   # Add tools
    return agent

# 3. Runtime Phase
def main(cls):
    # Choose running mode based on command line arguments
    if args.interactive:
        cls._run_interactive()      # Interactive mode
    elif args.query:
        cls._run_single_query()     # Single query
    else:
        cls._run_mcp_server()       # MCP server mode
```

#### Configuration System Details

FractFlow provides three-level configuration customization:

```python
# Level 1: Use default configuration
class SimpleTool(ToolTemplate):
    SYSTEM_PROMPT = "..."
    TOOL_DESCRIPTION = "..."
    # Automatically use DeepSeek default configuration

# Level 2: Partial customization
class CustomTool(ToolTemplate):
    SYSTEM_PROMPT = "..."
    TOOL_DESCRIPTION = "..."
    
    @classmethod
    def create_config(cls):
        return ConfigManager(
            provider='deepseek',           # Switch model provider
            openai_model='deepseek-reasoner',       # Specify model
            max_iterations=20           # Adjust iteration count
        )

# Level 3: Full customization
class AdvancedTool(ToolTemplate):
    SYSTEM_PROMPT = "..."
    TOOL_DESCRIPTION = "..."
    
    @classmethod
    def create_config(cls):
        from dotenv import load_dotenv
        load_dotenv()
        
        return ConfigManager(
            provider='qwen',
            anthropic_model='qwen-plus',
            max_iterations=50,
            temperature=0.7,
            custom_system_prompt=cls.SYSTEM_PROMPT + "\nAdditional instructions...",
            tool_calling_version='turbo',
            timeout=120
        )
```

## Tool Showcase

### Core Tools

#### File I/O Agent - File Operation Expert
```bash
# Basic file operations
python tools/core/file_io/file_io_agent.py --query "Read config.json file"
python tools/core/file_io/file_io_agent.py --query "Write 'Hello World' to output.txt"

# Advanced operations
python tools/core/file_io/file_io_agent.py --query "Read lines 100-200 of large file data.csv"
python tools/core/file_io/file_io_agent.py --query "Delete all lines containing 'ERROR' from temp.log"
```

**Feature Highlights**:
- Intelligent file operations: read, write, delete, insert
- Large file chunked processing
- Line-level precise operations
- Automatic directory creation

#### GPT Imagen Agent - AI Image Generation
```bash
# Image generation
python tools/core/gpt_imagen/gpt_imagen_agent.py --query "Generate image: save_path='spring_garden.png' prompt='a beautiful spring garden with flowers'"
python tools/core/gpt_imagen/gpt_imagen_agent.py --query "Generate image: save_path='robot.png' prompt='futuristic robot illustration'"
```

#### Web Search Agent - Web Search
```bash
# Web search
python tools/core/websearch/websearch_agent.py --query "Latest AI technology developments"
python tools/core/websearch/websearch_agent.py --query "Python performance optimization methods"
```

#### Weather Agent - Weather Query Assistant (US Only)
```bash
# Weather queries (US cities only)
python tools/core/weather/weather_agent.py --query "Weather in New York today"
python tools/core/weather/weather_agent.py --query "5-day forecast for San Francisco"
```

This tool can only query weather information within the United States.

#### Visual Question Answer - Visual Q&A
```bash
# Image understanding (based on Qwen-VL-Plus model)
python tools/core/visual_question_answer/vqa_agent.py --query "Image: /path/to/image.jpg What objects are in this picture?"
python tools/core/visual_question_answer/vqa_agent.py --query "Image: /path/to/photo.png Describe the scene in detail"
```

#### Realtime Voice Interactive - Real-time Voice Assistant

FractFlow provides an advanced real-time voice interaction system with support for multiple modes including the revolutionary **Manual Real-time Interruption Mode**:

```bash
# Frontend integration (recommended - supports four mode selection)
python ÂâçÁ´Ø/hkust_ai_assistant_entry.py
# Choose from: 1.Academic Q&A 2.Default Voice 3.Principal Ni Voice 4.Manual Real-time Interruption

# Command line direct launch
python ÂâçÁ´Ø/hkust_ai_assistant_entry.py --mode academic         # Academic Q&A mode
python ÂâçÁ´Ø/hkust_ai_assistant_entry.py --mode voice           # Default voice mode  
python ÂâçÁ´Ø/hkust_ai_assistant_entry.py --mode ni-voice        # Principal Ni voice mode
python ÂâçÁ´Ø/hkust_ai_assistant_entry.py --mode manual-interrupt # Manual real-time interruption mode

# Or use short parameters
python ÂâçÁ´Ø/hkust_ai_assistant_entry.py --voice-interactive      # Default voice
python ÂâçÁ´Ø/hkust_ai_assistant_entry.py --ni-voice-interactive   # Principal Ni voice
python ÂâçÁ´Ø/hkust_ai_assistant_entry.py --manual-interrupt       # Manual interruption

# Direct tool invocation
python tools/core/realtime_voice_interactive/realtime_voice_interactive.py     # Default voice
python tools/core/realtime_voice_interactive/realtime_voice_interactive.py ni  # Principal Ni voice

# Manual Real-time Interruption Mode (New!)
python tools/core/ÊâãÂä®ÂÆûÊó∂ÊâìÊñ≠/ËøêË°å_ÊâãÂä®ÂÆûÊó∂ÊâìÊñ≠.py                    # Default voice version
python tools/core/ÊâãÂä®ÂÆûÊó∂ÊâìÊñ≠/ËøêË°å_ÊâãÂä®ÂÆûÊó∂ÊâìÊñ≠_ÂÄ™Ê†°Áâà.py              # Principal Ni voice version
```

**üéØ Four Interactive Modes Comparison**:

| Mode | Voice Source | Use Case | Technical Features |
|------|-------------|----------|-------------------|
| üìö Academic Q&A | Text reply | Academic consulting, research support | Professional, rigorous, detailed |
| üé§ Default Voice | Qwen Omni built-in | Daily conversation, quick interaction | Stable, fast, ready-to-use |
| üéì Principal Ni Voice | Voice cloning technology | Formal occasions, academic communication | Authoritative, professional, streaming playback |
| ‚ö° Manual Real-time Interruption | Dual voice support | Ultimate control experience | **Millisecond-level interruption**, **zero-crash guarantee** |

**Feature Highlights**:
- üé§ **Real-time Speech Recognition**: Natural Chinese voice input with automatic text conversion
- üîä **Multiple Voice Modes**: Default system voice + Principal Ni's cloned voice + Manual control mode
- ‚ö° **Ultra-fast Interruption**: 0.01ms response time with multi-level interruption mechanism
- üéµ **Dynamic Volume Detection**: Adaptive background noise calibration and continuity verification
- üöÄ **Streaming TTS Playback**: Sentence-by-sentence generation for dramatically improved response speed (Principal Ni mode)
- üß† **Fractal Intelligence**: Nested agent calling with natural language priority
- üéØ **Enterprise-grade Experience**: Professional voice interaction solution

### ‚ö° Manual Real-time Interruption Mode - Revolutionary Control Experience

The **Manual Real-time Interruption Mode** represents a breakthrough in voice interaction technology, providing unprecedented control precision:

#### üöÄ Quick Start
```bash
# Interactive mode selection (recommended)
python ÂâçÁ´Ø/hkust_ai_assistant_entry.py
# Select option 4: ‚ö° Manual Real-time Interruption Mode

# Direct command line launch
python ÂâçÁ´Ø/hkust_ai_assistant_entry.py --mode manual-interrupt

# Direct tool execution
python tools/core/ÊâãÂä®ÂÆûÊó∂ÊâìÊñ≠/ËøêË°å_ÊâãÂä®ÂÆûÊó∂ÊâìÊñ≠.py                    # Default voice
python tools/core/ÊâãÂä®ÂÆûÊó∂ÊâìÊñ≠/ËøêË°å_ÊâãÂä®ÂÆûÊó∂ÊâìÊñ≠_ÂÄ™Ê†°Áâà.py              # Principal Ni voice
```

#### üéÆ Control Methods
```
Manual Control Instructions:
1. Press [Enter] to start recording
2. Speak your question
3. Press [Enter] again to stop recording and send
4. During AI response, press [Enter] to interrupt immediately ‚ö°
5. Type 'q' or 'quit' to exit
```

#### üìä Performance Metrics
| Metric | Before Optimization | After Optimization | Improvement |
|--------|-------------------|-------------------|-------------|
| Interruption Delay | 500-1000ms | **<50ms** | **20x faster** |
| HTTP Chunk Size | 1024 bytes | 256 bytes | 4x smaller |
| Audio Chunk Size | Large blocks | 64 bytes | 16x smaller |
| Response Precision | Second-level | **Millisecond-level** | 1000x improvement |
| Crash Rate | Occasional | **0%** | **100% reliability** |

#### üîß Technical Architecture
- **Multi-layer Stop Mechanism**: stop_flag + stop_event dual control
- **Forced Audio Stream Termination**: Immediate HTTP session closure
- **Thread-safe Optimization**: Independent playback threads with lock protection
- **Intelligent Memory Monitoring**: Three-level warning system with automatic cleanup
- **Zero-crash Guarantee**: Complete resolution of PyAudio segmentation fault

#### üí° Core Advantages
- ‚ö° **Millisecond Response**: <50ms interruption delay, 20x performance boost
- üéì **Dual Voice Support**: Both default system voice and Principal Ni voice
- üß† **Intelligent Context Memory**: Automatic conversation history management  
- üìä **Zero Crash Guarantee**: Production-level stability with 100% reliability
- üîß **MCP Server Support**: Can be called as a tool by other intelligent agents

#### üìÅ File Structure
```
tools/core/ÊâãÂä®ÂÆûÊó∂ÊâìÊñ≠/
‚îú‚îÄ‚îÄ README.md                          # Complete documentation
‚îú‚îÄ‚îÄ ÊâãÂä®ÂÆûÊó∂ÊâìÊñ≠_agent.py              # Default voice version
‚îú‚îÄ‚îÄ ÊâãÂä®ÂÆûÊó∂ÊâìÊñ≠_ÂÄ™Ê†°Áâà_agent.py        # Principal Ni voice version
‚îú‚îÄ‚îÄ ÊâãÂä®ÂÆûÊó∂ÊâìÊñ≠_mcp.py               # Default MCP server
‚îú‚îÄ‚îÄ ÊâãÂä®ÂÆûÊó∂ÊâìÊñ≠_ÂÄ™Ê†°Áâà_mcp.py         # Principal Ni MCP server
‚îú‚îÄ‚îÄ ËøêË°å_ÊâãÂä®ÂÆûÊó∂ÊâìÊñ≠.py              # Quick launch script (default)
‚îú‚îÄ‚îÄ ËøêË°å_ÊâãÂä®ÂÆûÊó∂ÊâìÊñ≠_ÂÄ™Ê†°Áâà.py        # Quick launch script (Principal Ni)
‚îî‚îÄ‚îÄ conversation_cache_manager.py      # Conversation cache manager
```

**General Usage Instructions**:
- Speak naturally to ask questions
- The system automatically interrupts AI responses when you start speaking (auto modes)
- Manual mode: Use Enter key for complete control over conversation flow
- Wait for complete AI responses before continuing the conversation
- Press Ctrl+C to exit
- Support text commands: "voice off" to switch to text mode

### Composite Tools

#### Visual Article Agent - Illustrated Article Generator

This is a typical representative of fractal intelligence, coordinating multiple tools to generate complete text-image content:

```bash
# Generate complete illustrated articles
python tools/composite/visual_article_agent.py --query "Write an article about AI development with illustrations"

# Customized articles
python tools/composite/visual_article_agent.py --query "ËÆæÂÆöÔºö‰∏Ä‰∏™ËßÜËßâËØÜÂà´AIÁªüÊ≤ªÁ§æ‰ºöÁöÑ‰∏ñÁïåÔºå‰∫∫Á±ªÂè™ËÉΩ‰æùËµñÂÆÉËß£ÈáäÂõæÂÉè„ÄÇ‰∏ª‰∫∫ÂÖ¨Âç¥Êã•Êúâ"‰∫∫Á±ªËßÜËßâÁõ¥Ëßâ"ÔºåÂπ∂Âõ†Ê≠§Ë¢´ÊÄÄÁñë‰∏∫ÂºÇÂ∏∏‰∏™‰Ωì„ÄÇ
Ë¶ÅÊ±ÇÔºö‰ª•Á¨¨‰∏Ä‰∫∫Áß∞ÔºåÂÜô‰∏ÄÊÆµÂâßÊÉÖÁâáÊÆµÔºåÂ±ïÁé∞‰ªñ‰∏éAIÊ®°ÂûãÂØπÂõæÂÉèÁêÜËß£ÁöÑÂÜ≤Á™Å„ÄÇ
ÊÉÖÁª™Âü∫Ë∞ÉÔºöÂÜ∑Â≥ª„ÄÅÊÄÄÁñë„ÄÅËØóÊÄß„ÄÇ"
```


![](assets/visual_article.gif)

**Workflow**:
1. Analyze article requirements and structure
2. Use `file_manager_agent` to write chapter content
3. Use `image_creator_agent` to generate supporting illustrations
4. Integrate into complete Markdown document

**Output Example**:
```
output/visual_article_generator/ai_development/
‚îú‚îÄ‚îÄ article.md           # Complete article
‚îî‚îÄ‚îÄ images/             # Supporting images
    ‚îú‚îÄ‚îÄ section1-fig1.png
    ‚îú‚îÄ‚îÄ section2-fig1.png
    ‚îî‚îÄ‚îÄ section3-fig1.png
```

#### Web Save Agent - Intelligent Web Saving
```bash
# Intelligent web saving (fractal intelligence example)
python tools/composite/web_save_agent.py --query "Search for latest Python tutorials and save to a comprehensive guide file"
python tools/composite/web_save_agent.py --query "Find information about machine learning and create an organized report"
```

**Feature Highlights**:
- Fractal intelligence combining web search and file saving
- Intelligent content organization and structuring
- Automatic file path management
- Multi-round search support

## API Reference

### Two Tool Development Approaches

FractFlow provides two flexible tool development approaches to meet different development needs:

#### Approach 1: Inherit ToolTemplate (Recommended)

Standardized tool development approach with automatic support for three running modes:

```python
from FractFlow.tool_template import ToolTemplate

class MyTool(ToolTemplate):
    """Standard tool class"""
    
    SYSTEM_PROMPT = """Your tool behavior instructions"""
    TOOL_DESCRIPTION = """Tool functionality description"""
    
    # Optional: depend on other tools
    TOOLS = [("path/to/tool.py", "tool_name")]
    
    @classmethod
    def create_config(cls):
        return ConfigManager(...)

# Automatically supports three running modes
# python my_tool.py                    # MCP server mode
# python my_tool.py --interactive      # Interactive mode  
# python my_tool.py --query "..."      # Single query mode
```

#### Approach 2: Custom Agent Class

Completely autonomous development approach:

```python
from FractFlow.agent import Agent
from FractFlow.infra.config import ConfigManager

async def main():
    # Custom configuration
    config = ConfigManager(
        provider='deepseek',
        deepseek_model='deepseek-chat',
        max_iterations=5
    )
    
    # Create Agent
    agent = Agent(config=config, name='my_agent')
    
    # Manually add tools
    agent.add_tool("./tools/weather/weather_mcp.py", "forecast_tool")
    
    # Initialize and use
    await agent.initialize()
    result = await agent.process_query("Your query")
    await agent.shutdown()
```

### ToolTemplate Base Class

FractFlow's core base class providing unified tool development framework:

```python
class ToolTemplate:
    """FractFlow tool template base class"""
    
    # Required attributes
    SYSTEM_PROMPT: str      # Agent system prompt
    TOOL_DESCRIPTION: str   # Tool functionality description
    
    # Optional attributes
    TOOLS: List[Tuple[str, str]] = []        # Dependent tools list
    MCP_SERVER_NAME: Optional[str] = None    # MCP server name
    
    # Core methods
    @classmethod
    def create_config(cls) -> ConfigManager:
        """Create configuration - can be overridden"""
        pass
    
    @classmethod
    async def create_agent(cls) -> Agent:
        """Create agent instance"""
        pass
    
    @classmethod
    def main(cls):
        """Main entry point - supports three running modes"""
        pass
```

#### Key Attribute Details

**Important Role of TOOL_DESCRIPTION**:

In FractFlow's fractal intelligence architecture, `TOOL_DESCRIPTION` is not just documentation for developers, but more importantly:

- **Reference manual for upper-layer Agents**: When a composite tool (like visual_article_agent) calls lower-layer tools, the upper-layer Agent reads the lower-layer tool's TOOL_DESCRIPTION to understand how to use it correctly
- **Tool interface specification**: Defines input parameter formats, return value structures, usage scenarios, etc.
- **Basis for intelligent calling**: Upper-layer Agents determine when and how to call specific tools based on this description

**Example**: When visual_article_agent calls file_io tool:
```python
# Upper-layer Agent reads file_io tool's TOOL_DESCRIPTION
# Then constructs call requests based on parameter formats described
TOOLS = [("tools/core/file_io/file_io_mcp.py", "file_operations")]
```

Therefore, writing clear and accurate TOOL_DESCRIPTION is crucial for the correct operation of fractal intelligence. However, TOOL_DESCRIPTION should not be too long.

**SYSTEM_PROMPT Writing Guidelines**:

Unlike TOOL_DESCRIPTION which faces upper-layer Agents, `SYSTEM_PROMPT` is the internal behavior instruction for the current Agent. Reference visual_article_agent's practice:

**Structured Design**:
```python
# Reference: tools/composite/visual_article_agent.py
SYSTEM_PROMPT = """
„ÄêStrict Constraints„Äë
‚ùå Absolutely Forbidden: Direct content output
‚úÖ Must Execute: Complete tasks through tool calls

„ÄêWorkflow„Äë
1. Analyze requirements
2. Call related tools
3. Verify results
"""
```

**Key Techniques**:
- **Clear Prohibitions**: Use `‚ùå` to define what cannot be done, avoiding common errors
- **Forced Execution**: Use `‚úÖ` to specify required behavior patterns
- **Process-oriented**: Break complex tasks into clear steps
- **Verification Mechanism**: Require confirmation of results after each step

This design ensures consistency and predictability of Agent behavior, which is key to reliable operation of composite tools.

### Configuration Management

```python
from FractFlow.infra.config import ConfigManager

# Basic configuration
config = ConfigManager()

# Custom configuration
config = ConfigManager(
    provider='openai',              # Model provider: openai/anthropic/deepseek
    openai_model='gpt-4',          # Specific model
    max_iterations=20,             # Maximum iterations
    temperature=0.7,               # Generation temperature
    custom_system_prompt="...",    # Custom system prompt
    tool_calling_version='stable', # Tool calling version: stable/turbo
    timeout=120                    # Timeout setting
)
```

## File Organization
```
tools/
‚îú‚îÄ‚îÄ core/                 # Core tools
‚îÇ   ‚îî‚îÄ‚îÄ your_tool/
‚îÇ       ‚îú‚îÄ‚îÄ your_tool_agent.py    # Main agent
‚îÇ       ‚îú‚îÄ‚îÄ your_tool_mcp.py      # MCP tool implementation
‚îÇ       ‚îî‚îÄ‚îÄ __init__.py
‚îî‚îÄ‚îÄ composite/            # Composite tools
    ‚îî‚îÄ‚îÄ your_composite_tool.py
```
#### Naming Conventions
- File names: `snake_case`
- Class names: `PascalCase`

## üéôÔ∏è Êñ∞ÂäüËÉΩÔºöÂçÉÈóÆOmniÂÆûÊó∂ËØ≠Èü≥‰∫§‰∫í

FractFlowÁé∞Âú®ÊîØÊåÅÂü∫‰∫éÂçÉÈóÆOmniÁöÑÂÆûÊó∂ËØ≠Èü≥‰∫§‰∫íÂäüËÉΩÔºåÂåÖÊã¨Ôºö

- ‚ö° **ÂÆûÊó∂ËØ≠Èü≥ÊâìÊñ≠** - Âú®AIËØ¥ËØùÊó∂ÂèØ‰ª•ÈöèÊó∂ÊâìÊñ≠
- üé§ **Êô∫ËÉΩËØ≠Èü≥Ê¥ªÂä®Ê£ÄÊµã** (VAD) - Èôç‰ΩéÈòàÂÄºÊèêÈ´òÊïèÊÑüÂ∫¶  
- üîä **ÂèåÂêëÈü≥È¢ëÊµÅ** - ÊîØÊåÅÂêåÊó∂ÂΩïÈü≥ÂíåÊí≠Êîæ
- üßµ **Â§öÁ∫øÁ®ãÂ§ÑÁêÜ** - Áã¨Á´ãÁöÑÂΩïÈü≥„ÄÅÂ§ÑÁêÜ„ÄÅÊí≠ÊîæÁ∫øÁ®ã
- üîÑ **WebSocketÂÆûÊó∂ÈÄö‰ø°** - ‰∏éÂçÉÈóÆOmni APIÂª∫Á´ãÊåÅ‰πÖËøûÊé•
- üìù **ËØ≠Èü≥ËΩ¨ÂΩïÊòæÁ§∫** - ÂÆûÊó∂ÊòæÁ§∫ÂØπËØùÂÜÖÂÆπ

## üöÄ Âø´ÈÄüÂºÄÂßã

### ÂÆâË£Ö‰æùËµñ

```bash
# ‰ΩøÁî®uvÂÆâË£ÖÔºàÊé®ËçêÔºâ
uv install

# Êàñ‰ΩøÁî®pip
pip install -r requirements.txt

# ÂÆâË£ÖÈü≥È¢ë‰æùËµñ
uv add pyaudio numpy
```

### ÈÖçÁΩÆAPIÂØÜÈí•

1. Â§çÂà∂ÈÖçÁΩÆÊ®°ÊùøÔºö
```bash
cp config.env.example .env
```

2. ÁºñËæë `.env` Êñá‰ª∂ÔºåÂ°´ÂÖ•ÊÇ®ÁöÑAPIÂØÜÈí•Ôºö
```bash
QWEN_API_KEY=your_qwen_api_key_here
DASHSCOPE_API_KEY=your_dashscope_api_key_here
```

### ËØ≠Èü≥‰∫§‰∫í‰ΩøÁî®

#### ÂÆåÁæéÁâàËØ≠Èü≥ËÅäÂ§©ÔºàÊé®ËçêÔºâ
```bash
python perfect_voice_chat.py
```

#### ÂÖ∂‰ªñËØ≠Èü≥ÂäüËÉΩ
```bash
# Âü∫Á°ÄËØ≠Èü≥ËÅäÂ§©
python qwen_voice_chat.py

# ÂÆåÊï¥ÂäüËÉΩÂêØÂä®Âô®
python start_qwen_voice_complete.py

# ËØ≠Èü≥ÊâìÊñ≠ÊµãËØï
python test_voice_interrupt.py

# Èü≥È¢ëËØäÊñ≠Â∑•ÂÖ∑
python audio_diagnostic.py

# macOSÊùÉÈôê‰øÆÂ§ç
python macos_voice_permission_fix.py
```

## üé§ ËØ≠Èü≥Á≥ªÁªüÁâπÊÄß

### Êô∫ËÉΩËÆæÂ§áÈÄâÊã©
- Ëá™Âä®ËØÜÂà´ÂíåÈÄâÊã©ÊúÄ‰Ω≥È∫¶ÂÖãÈ£éËÆæÂ§á
- ‰ºòÂÖà‰ΩøÁî®MacBookÂÜÖÁΩÆÈ∫¶ÂÖãÈ£é
- ÈÅøÂÖçÂÖºÂÆπÊÄßÈóÆÈ¢òËÆæÂ§áÔºàÂ¶ÇÊüê‰∫õËìùÁâôËÄ≥Êú∫Ôºâ

### ‰ºòÂåñÁöÑVADÂèÇÊï∞
- threshold: 0.15 (Âπ≥Ë°°ÊïèÊÑüÂ∫¶)
- prefix_padding_ms: 150 (ÈÄÇ‰∏≠ÁöÑÂâçÁºÄ)
- silence_duration_ms: 400 (ÈÄÇ‰∏≠ÁöÑÈùôÈü≥Êó∂Èó¥)

### ÂÆûÊó∂ÊâìÊñ≠Êú∫Âà∂
- Ê£ÄÊµãÂà∞Áî®Êà∑ËØ¥ËØùÁ´ãÂç≥ÂÅúÊ≠¢AIÊí≠Êîæ
- Ê∏ÖÁ©∫Èü≥È¢ëÊí≠ÊîæÁºìÂÜ≤Âå∫
- ÂèëÈÄÅÂèñÊ∂à‰ø°Âè∑ÁªôÊúçÂä°Âô®

## üõ†Ô∏è ÊïÖÈöúÊéíÈô§

### macOSÈ∫¶ÂÖãÈ£éÊùÉÈôê
Â¶ÇÊûúÈÅáÂà∞ËØ≠Èü≥Ê£ÄÊµãÈóÆÈ¢òÔºö
1. ËøêË°åÊùÉÈôê‰øÆÂ§çÂ∑•ÂÖ∑Ôºö`python macos_voice_permission_fix.py`
2. Âú®Á≥ªÁªüÂÅèÂ•ΩËÆæÁΩÆ > ÂÆâÂÖ®ÊÄß‰∏éÈöêÁßÅ > ÈöêÁßÅ > È∫¶ÂÖãÈ£é‰∏≠Ê∑ªÂä†ÁªàÁ´ØÂ∫îÁî®
3. ÈáçÂêØÁªàÁ´ØÂ∫îÁî®Á®ãÂ∫è

### Èü≥È¢ëËÆæÂ§áÈóÆÈ¢ò
```bash
# ËøêË°åÈü≥È¢ëËØäÊñ≠
python audio_diagnostic.py

# Ê∑±Â∫¶Ë∞ÉËØï
python deep_voice_debug.py
```

### Â∏∏ËßÅÈóÆÈ¢ò
- **Êó†Ê≥ïÊ£ÄÊµãËØ≠Èü≥**: Ê£ÄÊü•È∫¶ÂÖãÈ£éÊùÉÈôêÔºåÂ∞ùËØïÊõ¥Â§ßÂ£∞ËØ¥ËØù
- **ËøûÊé•Â§±Ë¥•**: Ê£ÄÊü•APIÂØÜÈí•ÂíåÁΩëÁªúËøûÊé•
- **Èü≥È¢ëË¥®ÈáèÂ∑Æ**: Â∞ùËØï‰ΩøÁî®ÂÜÖÁΩÆÈ∫¶ÂÖãÈ£éËÄåÈùûËìùÁâôËÆæÂ§á

## üìä È°πÁõÆÁªìÊûÑ

```
FractFlow/
‚îú‚îÄ‚îÄ FractFlow/                      # Ê†∏ÂøÉÊ°ÜÊû∂
‚îÇ   ‚îú‚îÄ‚îÄ agent.py                   # ‰∏ªË¶ÅAgentÁ±ª
‚îÇ   ‚îú‚îÄ‚îÄ core/                      # Ê†∏ÂøÉÁªÑ‰ª∂
‚îÇ   ‚îú‚îÄ‚îÄ models/                    # AIÊ®°ÂûãÈõÜÊàê
‚îÇ   ‚îî‚îÄ‚îÄ ui/                        # Áî®Êà∑ÁïåÈù¢
‚îú‚îÄ‚îÄ tools/                         # Â∑•ÂÖ∑ÈõÜÂêà
‚îÇ   ‚îú‚îÄ‚îÄ core/                      # Ê†∏ÂøÉÂ∑•ÂÖ∑
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ qwen_realtime_voice/   # ËØ≠Èü≥‰∫§‰∫íÂ∑•ÂÖ∑
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ comfyui/              # ComfyUIÈõÜÊàê
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ file_io/              # Êñá‰ª∂Êìç‰Ωú
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...                   # ÂÖ∂‰ªñÂ∑•ÂÖ∑
‚îÇ   ‚îî‚îÄ‚îÄ custom/                    # Ëá™ÂÆö‰πâÂ∑•ÂÖ∑
‚îú‚îÄ‚îÄ perfect_voice_chat.py          # ÂÆåÁæéÁâàËØ≠Èü≥ËÅäÂ§©
‚îú‚îÄ‚îÄ audio_diagnostic.py            # Èü≥È¢ëËØäÊñ≠Â∑•ÂÖ∑
‚îî‚îÄ‚îÄ config.env.example            # ÈÖçÁΩÆÊ®°Êùø
```

## üéØ ËØ≠Èü≥‰∫§‰∫íÂ∑•‰ΩúÊµÅÁ®ã

1. **ËøûÊé•Âª∫Á´ã** - ‰∏éÂçÉÈóÆOmni APIÂª∫Á´ãWebSocketËøûÊé•
2. **Èü≥È¢ëÂàùÂßãÂåñ** - ËÆæÁΩÆÂΩïÈü≥ÂíåÊí≠ÊîæËÆæÂ§á
3. **ÂÆûÊó∂ÂΩïÈü≥** - ÊåÅÁª≠ÂΩïÂà∂Áî®Êà∑ËØ≠Èü≥ËæìÂÖ•
4. **ËØ≠Èü≥Ê£ÄÊµã** - ÊúçÂä°Âô®Á´ØVADÊ£ÄÊµãËØ≠Èü≥Ê¥ªÂä®
5. **ËØ≠Èü≥ËØÜÂà´** - Â∞ÜËØ≠Èü≥ËΩ¨Êç¢‰∏∫ÊñáÊú¨
6. **AIÂ§ÑÁêÜ** - ÁîüÊàêÂõûÂ§çÂÜÖÂÆπ
7. **ËØ≠Èü≥ÂêàÊàê** - Â∞ÜÂõûÂ§çËΩ¨Êç¢‰∏∫ËØ≠Èü≥
8. **Èü≥È¢ëÊí≠Êîæ** - Êí≠ÊîæAIËØ≠Èü≥ÂõûÂ§ç
9. **ÊâìÊñ≠Â§ÑÁêÜ** - ÊîØÊåÅÁî®Êà∑ÈöèÊó∂ÊâìÊñ≠AIËØ¥ËØù

## üîß ÊäÄÊúØÊû∂ÊûÑ

- **WebSocketÈÄö‰ø°**: ÂÆûÊó∂ÂèåÂêëÊï∞ÊçÆ‰º†Ëæì
- **Â§öÁ∫øÁ®ãÂ§ÑÁêÜ**: ÂΩïÈü≥„ÄÅÂ§ÑÁêÜ„ÄÅÊí≠ÊîæÁã¨Á´ãÁ∫øÁ®ã
- **Èü≥È¢ëÊµÅÂ§ÑÁêÜ**: PyAudio + 16kHz PCMÊ†ºÂºè
- **Êô∫ËÉΩVAD**: ÊúçÂä°Âô®Á´ØËØ≠Èü≥Ê¥ªÂä®Ê£ÄÊµã
- **ÁºìÂÜ≤ÁÆ°ÁêÜ**: Èü≥È¢ëÊï∞ÊçÆÈòüÂàóÂíåÁºìÂÜ≤Âå∫ÁÆ°ÁêÜ

## üìù ÂºÄÂèëÊåáÂçó

### Ê∑ªÂä†Êñ∞ÁöÑËØ≠Èü≥ÂäüËÉΩ
```python
from tools.core.qwen_realtime_voice.qwen_realtime_voice_mcp import QwenRealtimeVoiceClient

class CustomVoiceClient(QwenRealtimeVoiceClient):
    def __init__(self):
        super().__init__()
        # Ëá™ÂÆö‰πâÂàùÂßãÂåñ
    
    async def _handle_responses(self):
        # Ëá™ÂÆö‰πâÂìçÂ∫îÂ§ÑÁêÜ
        await super()._handle_responses()
```

### Ëá™ÂÆö‰πâVADÂèÇÊï∞
```python
config = {
    "turn_detection": {
        "type": "server_vad",
        "threshold": 0.2,        # Ë∞ÉÊï¥ÊïèÊÑüÂ∫¶
        "prefix_padding_ms": 200, # Ë∞ÉÊï¥ÂâçÁºÄÊó∂Èó¥
        "silence_duration_ms": 500 # Ë∞ÉÊï¥ÈùôÈü≥Âà§Êñ≠
    }
}
```

## ü§ù Ë¥°ÁåÆÊåáÂçó

1. Fork È°πÁõÆ
2. ÂàõÂª∫ÁâπÊÄßÂàÜÊîØ (`git checkout -b feature/AmazingFeature`)
3. Êèê‰∫§Êõ¥Êîπ (`git commit -m 'Add some AmazingFeature'`)
4. Êé®ÈÄÅÂà∞ÂàÜÊîØ (`git push origin feature/AmazingFeature`)
5. ÊâìÂºÄ Pull Request

## üìÑ ËÆ∏ÂèØËØÅ

Êú¨È°πÁõÆÂü∫‰∫é MIT ËÆ∏ÂèØËØÅÂºÄÊ∫ê„ÄÇËØ¶ËßÅ [LICENSE](LICENSE) Êñá‰ª∂„ÄÇ

## üôè Ëá¥Ë∞¢

- [ÂçÉÈóÆOmni](https://dashscope.aliyuncs.com/) - Êèê‰æõÂÆûÊó∂ËØ≠Èü≥‰∫§‰∫íAPI
- [PyAudio](https://pypi.org/project/PyAudio/) - Èü≥È¢ëÂ§ÑÁêÜÂ∫ì
- [WebSockets](https://pypi.org/project/websockets/) - WebSocketÈÄö‰ø°

## üìû ËÅîÁ≥ªÊàë‰ª¨

Â¶ÇÊûúÊÇ®Êúâ‰ªª‰ΩïÈóÆÈ¢òÊàñÂª∫ËÆÆÔºåËØ∑ÈÄöËøá‰ª•‰∏ãÊñπÂºèËÅîÁ≥ªÔºö

- ÂàõÂª∫ [Issue](https://github.com/yourusername/FractFlow/issues)
- ÂèëÈÄÅÈÇÆ‰ª∂Âà∞: your-email@example.com

---

‚≠ê Â¶ÇÊûúËøô‰∏™È°πÁõÆÂØπÊÇ®ÊúâÂ∏ÆÂä©ÔºåËØ∑ÁªôÊàë‰ª¨‰∏Ä‰∏™ÊòüÊ†áÔºÅ
